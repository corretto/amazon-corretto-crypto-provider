# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0.

version: 0.2

phases:
  build:
    commands:
      # vcvarsall will set the required lib and libpath for MSVC to compile everything
      - .\tests\ci\run_windows_tests.bat "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat"


setx /M PATH "%PATH%;C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64"

rmdir /s "C:\Program Files (x86)\Windows Kits\10\bin\x64" /y
rmdir /s "C:\Program Files (x86)\Windows Kits\10\bin\x86" /y
move "C:\Program Files (x86)\Windows Kits\10\bin\10.0.17763.0\x64" "C:\Program Files (x86)\Windows Kits\10\bin"
move "C:\Program Files (x86)\Windows Kits\10\bin\10.0.17763.0\x86" "C:\Program Files (x86)\Windows Kits\10\bin"

.\tests\ci\run_windows_tests.bat  "C:\Program Files (x86)\Microsoft Visual Studio\2015\BuildTools\VC\Auxiliary\Build\vcvarsall.bat"

curl -SL --output vs_buildtools.exe https://download.microsoft.com/download/E/E/D/EEDF18A8-4AED-4CE0-BEBE-70A83094FC5A/BuildTools_Full.exe




RUN `
    # Download the Build Tools bootstrapper.
    # curl -SL --output vs_buildtools.exe https://aka.ms/vs/15/release/vs_buildtools.exe `
    curl -SL --output vs_buildtools.exe https://download.microsoft.com/download/E/E/D/EEDF18A8-4AED-4CE0-BEBE-70A83094FC5A/BuildTools_Full.exe `
    `
    # Install Build Tools with the Microsoft.VisualStudio.Workload.AzureBuildTools workload, excluding workloads and components with known issues.
    && (start /w vs_buildtools.exe --quiet --wait --norestart --nocache `
        --installPath "C:\Program Files (x86)\Microsoft Visual Studio\2015\BuildTools" `
        --add Microsoft.VisualStudio.Component.Windows81SDK `
        --add Microsoft.VisualStudio.ComponentGroup.NativeDesktop.Win81 `
        --add Microsoft.VisualStudio.Workload.VCTools `
        --add Microsoft.Component.VC.Runtime.UCRTSDK `
        --add Microsoft.VisualStudio.Component.VC.ATL `
        --add Microsoft.VisualStudio.Component.VC.ATLMFC `
        --add Microsoft.VisualStudio.Component.TestTools.BuildTools `
        --add Microsoft.VisualStudio.Component.VC.CLI.Support `
        --add Microsoft.VisualStudio.Component.VC.140 `
        --add Microsoft.VisualStudio.Component.VC.CMake.Project `
        || IF "%ERRORLEVEL%"=="3010" EXIT 0) `
    `
    # Cleanup
    && del /q vs_buildtools.exe


RUN choco install strawberryperl --version=5.32.0.1 -y